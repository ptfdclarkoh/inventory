<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Updated viewport for an app-like feel, preventing zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
    
    <!-- === iPad/iPhone "Add to Home Screen" App Settings === -->
    
    <!-- Makes the web app run in full-screen mode without browser chrome -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Added for modern browser compatibility -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Sets the title for the app icon on the home screen -->
    <meta name="apple-mobile-web-app-title" content="Supplies">
    
    <!-- 
      Sets the status bar style. 'default' is standard. 
      'black' or 'black-translucent' are other options.
    -->
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- 
      Specifies the app icon (180x180 is recommended for modern iPads).
      Using a placeholder to prevent 404 errors.
    -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <!-- === End App Settings === -->
    
    <title>PTFD Supplies Inventory</title>
    <!-- 1. Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6; /* A slightly softer gray */
        }
        
        /* Style for the fixed header on the form */
        #formHeader {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10;
            /* Add padding to match the form's padding */
            padding-top: 1.5rem; /* p-6 */
            margin-top: -1.5rem; /* Pull it up to cover original padding */
        }

        /* Active state for button choices */
        .btn-choice.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6;
        }

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* Custom styles for date and time inputs to ensure proper sizing */
        input[type="date"], input[type="datetime-local"] {
            width: 90%; /* Reverts to the browser's default sizing */
            max-width: 100%; /* Ensures it doesn't exceed its container */
            box-sizing: border-box;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- NEW: Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-center space-x-4">
                <!-- Links to other pages -->
                <a href="index.html" class="text-blue-600 border-b-2 border-blue-600 px-3 py-4 font-medium" aria-current="page">Log Inventory</a>
                <a href="transactions.html" class="text-gray-500 hover:text-blue-600 px-3 py-4 font-medium">View Transactions</a>
            </div>
        </div>
    </nav>


    <!-- Main Container -->
    <!-- Removed 'container' class to allow full width -->
    <!-- Added pt-4 to give space below the new nav -->
    <div class="p-4 sm:p-6 lg:p-8 pt-4">

        <!-- Grid Layout -->
        <!-- CHANGED: from lg:grid-cols-3 to lg:grid-cols-4 -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <!-- Left Column: Form -->
            <!-- CHANGED: from lg:col-span-1 (of 3) to lg:col-span-1 (of 4) -->
            <!-- CHANGED: Removed fixed height on lg screens. Now h-auto, so page will scroll -->
            <!-- Made form sticky on large screens -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-[90vh] overflow-y-auto lg:h-[calc(100vh-6rem)] lg:sticky lg:top-20">
                
                <!-- Sticky Form Header -->
                <div id="formHeader" class="border-b pb-4 mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">PTFD EMS Inventory</h2>
                    <p class="text-gray-500">Add or edit an item.</p>
                </div>
                
                <form id="inventoryForm" class="space-y-6">
                    
                    <!-- Hidden input for tracking edits -->
                    <input type="hidden" id="editDocId" name="editDocId">

                    <!-- Cabinet Buttons -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cabinet</label>
                        <div id="cabinetButtons" class="grid grid-cols-5 gap-2">
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="1">1</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="2">2</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="3">3</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="4">4</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="DC">DC</button>
                        </div>
                        <input type="hidden" id="cabinet" name="cabinet">
                    </div>

                    <!-- Shelf Buttons -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Shelf</label>
                        <div id="shelfButtons" class="grid grid-cols-4 gap-2">
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="A">A</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="B">B</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="C">C</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg text-lg font-semibold text-gray-700 hover:bg-gray-100" data-value="D">D</button>
                        </div>
                        <input type="hidden" id="shelf" name="shelf">
                    </div>

                    <!-- Item -->
                    <div>
                        <label for="item" class="block text-sm font-medium text-gray-700">Item</label>
                        <input type="text" name="item" id="item" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Quantity -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" name="quantity" id="quantity" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Earliest Expiration -->
                    <div>
                        <label for="earliestExpiration" class="block text-sm font-medium text-gray-700">Earliest Expiration</label>
                        <input type="date" name="earliestExpiration" id="earliestExpiration" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-gray-700">
                    </div>

                    <!-- Notes -->
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea name="notes" id="notes" rows="4" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- Form Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button type="submit" id="submitButton" class="w-full flex-1 justify-center py-3 px-6 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Save Entry
                        </button>
                        <button type="button" id="clearButton" class="w-full sm:w-auto justify-center py-3 px-6 border border-gray-300 rounded-lg shadow-sm text-lg font-semibold text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            Clear
                        </button>
                    </div>
                </form>

                <!-- Feedback Message Area -->
                <div id="message" class="mt-6 p-4 rounded-lg text-center" style="display: none;"></div>
            </div>

            <!-- Right Column: Data Table -->
            <!-- Set explicit heights for scrolling on mobile and desktop -->
            <!-- CHANGED: from lg:col-span-2 (of 3) to lg:col-span-3 (of 4) -->
            <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg h-[90vh] lg:h-[calc(100vh-6rem)] overflow-y-auto">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">Existing Supplies</h2>

                <!-- Search and Export -->
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="text" id="searchBox" class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Search by item, notes, or expiration...">
                    
                    <button id="exportButton" class="w-full sm:w-auto justify-center py-3 px-6 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Export to CSV
                    </button>
                </div>

                <!-- Table Container -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cabinet</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Shelf</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Item</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Quantity</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Expiration</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Notes</th>
                                <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Updated</th>
                                <!-- <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Edit</th> -->
                                <!-- <th class="p-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Delete</th> -->
                            </tr>
                        </thead>
                        <tbody id="entriesTable" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                    <!-- Loading State -->
                    <div id="loadingIndicator" class="flex flex-col items-center justify-center p-8">
                        <div class="spinner"></div>
                        <p class="text-gray-500 mt-4">Loading entries...</p>
                    </div>
                    <p id="loadingMessage" class="text-gray-500 text-center p-8" style="display: none;">Authenticating and loading entries...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit/Delete Choice Modal -->
    <div id="editDeleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 40;">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <!-- Heroicons: outline/pencil-square -->
                    <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="editModalTitle">Modify or Delete Entry</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">What would you like to do with <strong id="editModalItemName" class="text-gray-700">this item</strong>?</p>
                </div>
                <div class="items-center px-4 py-3 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="modalModify" class="px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md w-full sm:w-28 shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        Modify
                    </button>
                    <button id="modalDelete" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full sm:w-28 shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Delete
                    </button>
                    <button id="modalChoiceCancel" class="px-4 py-2 bg-gray-300 text-gray-900 text-base font-medium rounded-md w-full sm:w-28 shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 50;">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <!-- Heroicons: outline/exclamation-triangle -->
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4" id="modalTitle">Delete Entry</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modalMessage">Are you sure you want to delete this item? This action cannot be undone.</p>
                </div>
                <div class="items-center px-4 py-3 flex justify-center space-x-4">
                    <button id="modalConfirmDelete" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Delete
                    </button>
                    <button id="modalCancel" class="px-4 py-2 bg-gray-300 text-gray-900 text-base font-medium rounded-md w-24 shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 
      Using a module script to import Firebase services.
      This is the modern way to use Firebase on the web.
    -->
    <script type="module">
        // Import functions from the Firebase SDK
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            deleteDoc,
            onSnapshot, 
            collection, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        // REVERTED to the hardcoded config from your original file to fix auth errors
        const firebaseConfig = {
          apiKey: "AIzaSyBTjbo2ndQYowrvmcDxeXfvNb_E3nSijH8",
          authDomain: "ems-inventory.firebaseapp.com",
          projectId: "ems-inventory",
          storageBucket: "ems-inventory.firebasestorage.app",
          messagingSenderId: "1076236960850",
          appId: "1:1076236960850:web:07cc24cd638ef4a8298b8b",
          measurementId: "G-BFFXWP4G42"
        };
        // ----------------------------------------
        
        // REVERTED to the original collection name
        const COLLECTION_NAME = 'supplies';

        // --- Global Variables ---
        let db;
        let auth;
        let currentUserId; // To hold the authenticated user's ID
        let entriesListener = null; // To hold the onSnapshot unsubscribe function
        
        // --- Form Elements ---
        const form = document.getElementById('inventoryForm');
        const message = document.getElementById('message');
        const submitButton = document.getElementById('submitButton');
        const clearButton = document.getElementById('clearButton');
        const editDocIdInput = document.getElementById('editDocId');
        
        // --- Table Elements ---
        const tableBody = document.getElementById('entriesTable');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const loadingMessage = document.getElementById('loadingMessage');
        const searchBox = document.getElementById('searchBox');
        
        // --- Button Choice Elements ---
        const cabinetButtonsContainer = document.getElementById('cabinetButtons');
        const hiddenCabinetInput = document.getElementById('cabinet');
        const shelfButtonsContainer = document.getElementById('shelfButtons');
        const hiddenShelfInput = document.getElementById('shelf');
        const exportButton = document.getElementById('exportButton');
        const deleteModal = document.getElementById('deleteModal');
        const modalConfirmDelete = document.getElementById('modalConfirmDelete');
        const modalCancel = document.getElementById('modalCancel');
        const modalMessage = document.getElementById('modalMessage');
        
        // --- New Modal Elements ---
        const editDeleteModal = document.getElementById('editDeleteModal');
        const editModalItemName = document.getElementById('editModalItemName');
        const modalModify = document.getElementById('modalModify');
        const modalDelete = document.getElementById('modalDelete');
        const modalChoiceCancel = document.getElementById('modalChoiceCancel');
        
        let allEntries = []; // To store a local copy of all entries for searching
        let docIdToDelete = null; // To store which doc to delete
        let selectedEntry = null; // To store the entry from the clicked row

        /**
         * Displays a feedback message to the user.
         * @param {string} msg - The message to show.
         * @param {boolean} isError - True for error, false for success.
         */
        function showMessage(msg, isError = false) {
            message.textContent = msg;
            message.className = `mt-6 p-4 rounded-lg text-center ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            message.style.display = 'block';
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        /**
         * Renders the data into the HTML table.
         * @param {Array} entries - An array of entry objects from Firestore.
         */
        function renderTable(entries) {
            // Sort entries: by cabinet, then by shelf, then by item name (case-insensitive)
            entries.sort((a, b) => {
                const cabinetA = a.cabinet || '';
                const cabinetB = b.cabinet || '';
                const shelfA = a.shelf || '';
                const shelfB = b.shelf || '';
                const itemA = (a.item || '').toLowerCase();
                const itemB = (b.item || '').toLowerCase();

                if (cabinetA < cabinetB) return -1;
                if (cabinetA > cabinetB) return 1;
                
                if (shelfA < shelfB) return -1;
                if (shelfA > shelfB) return 1;

                if (itemA < itemB) return -1;
                if (itemA > itemB) return 1;
                
                return 0;
            });

            // Store for searching
            allEntries = entries; 
            
            // Filter based on search box *before* rendering
            const query = searchBox.value.toLowerCase().trim();
            const entriesToRender = query ? filterEntries(entries, query) : entries;
            
            tableBody.innerHTML = ''; // Clear existing table
            if (entriesToRender.length === 0) {
                if (query && entries.length > 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No items match your search.</td></tr>`;
                } else {
                    tableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No supplies found. Add one using the form.</td></tr>`;
                }
                return;
            }

            entriesToRender.forEach(entry => {
                // Format expiration date (if it exists)
                let expDate = 'N/A';
                if (entry.earliestExpiration) {
                    try {
                        // Firestore dates are often strings, so we re-parse
                        const date = new Date(entry.earliestExpiration);
                        // Add 1 day to correct for timezone offset on 'YYYY-MM-DD'
                        date.setUTCDate(date.getUTCDate() + 1);
                        expDate = date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            timeZone: 'UTC' // Use UTC to avoid timezone shifts
                        });
                    } catch (e) {
                        console.warn("Could not parse date:", entry.earliestExpiration);
                        expDate = entry.earliestExpiration; // show as-is
                    }
                }

                // Format "last updated" timestamp
                let updatedDate = 'N/A';
                if (entry.lastUpdated && entry.lastUpdated.toDate) { // Check if it's a Firestore Timestamp
                    updatedDate = entry.lastUpdated.toDate().toLocaleString('en-US', {
                        month: '2-digit',
                        day: '2-digit',
                        year: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                const row = `
                    <tr class="entry-row hover:bg-gray-50 cursor-pointer" data-id="${entry.id}">
                        <td class="p-3 whitespace-nowrap text-sm font-semibold text-gray-900">${entry.cabinet || ''}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-semibold text-gray-900">${entry.shelf || ''}</td>
                        <td class="p-3 whitespace-nowrap text-sm font-semibold text-gray-900">${entry.item || ''}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${entry.quantity ?? ''}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${expDate}</td>
                        <td class="p-3 text-sm text-gray-500" style="white-space: pre-wrap; min-width: 150px; word-break: break-word;">${entry.notes || ''}</td>
                        <td class="p-3 whitespace-nowrap text-sm text-gray-500">${updatedDate}</td>
                        <!--
                        <td class="p-3 whitespace-nowrap">
                            <button type="button" class="edit-btn bg-green-500 text-white text-xs py-1 px-3 rounded-md hover:bg-green-600" data-row-id="${entry.id}">
                                Edit
                            </button>
                        </td>
                        <td class="p-3 whitespace-nowrap">
                            <button type="button" class="delete-btn bg-red-500 text-white text-xs py-1 px-3 rounded-md hover:bg-red-600" data-row-id="${entry.id}">
                                Delete
                            </button>
                        </td>
                        -->
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Add event listeners to all new "Edit" buttons
            // document.querySelectorAll('.edit-btn').forEach(button => {
            //     button.addEventListener('click', handleEditClick);
            // });
            
            // Add event listeners to all new "Delete" buttons
            // document.querySelectorAll('.delete-btn').forEach(button => {
            //     button.addEventListener('click', handleDeleteClick);
            // });

            // --- NEW: Add event listeners to all table rows ---
            document.querySelectorAll('.entry-row').forEach(row => {
                row.addEventListener('click', handleRowClick);
            });
        }

        /**
         * Main form submission handler.
         * Decides whether to add a new doc or update an existing one.
         * @param {Event} e - The form submit event.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!auth.currentUser) {
                showMessage('Not authenticated. Please wait and try again.', true);
                return;
            }

            const formData = new FormData(form);
            const data = {
                cabinet: formData.get('cabinet'),
                shelf: formData.get('shelf'),
                item: formData.get('item'),
                quantity: formData.get('quantity') ? Number(formData.get('quantity')) : null,
                earliestExpiration: formData.get('earliestExpiration') || null,
                notes: formData.get('notes'),
                lastUpdated: serverTimestamp() // Let Firestore set the time
            };
            
            const docId = editDocIdInput.value;
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';

            try {
                if (docId) {
                    // --- UPDATE existing document ---
                    const docRef = doc(db, COLLECTION_NAME, docId);
                    await setDoc(docRef, data, { merge: true }); // merge: true preserves other fields if any
                    showMessage('Entry updated successfully!', false);
                } else {
                    // --- ADD new document ---
                    const collectionRef = collection(db, COLLECTION_NAME);
                    await addDoc(collectionRef, data);
                    showMessage('Entry added successfully!', false);
                }
                clearForm(); // Clear form on success
            } catch (error) {
                console.error('Error saving document:', error);
                showMessage(`Error: ${error.message}`, true);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Save Entry';
            }
        }

        /**
         * Clears all form fields and resets button/edit state.
         */
        function clearForm() {
            form.reset();
            editDocIdInput.value = '';
            submitButton.textContent = 'Save Entry';
            
            // Clear cabinet button selection
            document.querySelectorAll('#cabinetButtons .btn-choice').forEach(btn => {
                btn.classList.remove('active');
            });
            hiddenCabinetInput.value = '';
            
            // Clear shelf button selection
            document.querySelectorAll('#shelfButtons .btn-choice').forEach(btn => {
                btn.classList.remove('active');
            });
            hiddenShelfInput.value = '';
        }

        /**
         * Handles selecting a button (Cabinet or Shelf).
         * @param {Event} e - The click event.
         * @param {HTMLElement} container - The button container (e.g., cabinetButtonsContainer).
         * @param {HTMLInputElement} hiddenInput - The hidden input to update.
         */
        function handleButtonChoice(e, container, hiddenInput) {
            const clickedButton = e.target.closest('.btn-choice');
            if (!clickedButton) return; // Didn't click a button

            // Remove 'active' from all siblings
            container.querySelectorAll('.btn-choice').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add 'active' to the clicked button
            clickedButton.classList.add('active');
            
            // Set the hidden input's value
            hiddenInput.value = clickedButton.dataset.value;
        }

        /**
         * Populates the form with data from an existing entry for editing.
         * @param {string} docId - The document ID of the entry to edit.
         */
        function handleEditClick(docId) {
            // const docId = e.target.dataset.rowId; // No longer from event
            const entry = allEntries.find(item => item.id === docId);

            if (!entry) {
                showMessage('Could not find entry to edit.', true);
                return;
            }

            // Populate form fields
            form.item.value = entry.item || '';
            form.quantity.value = entry.quantity || '';
            form.earliestExpiration.value = entry.earliestExpiration || '';
            form.notes.value = entry.notes || '';
            editDocIdInput.value = docId; // Set the hidden ID

            // Set Cabinet button
            document.querySelectorAll('#cabinetButtons .btn-choice').forEach(btn => {
                if (btn.dataset.value === entry.cabinet) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            hiddenCabinetInput.value = entry.cabinet || '';
            
            // Set Shelf button
            document.querySelectorAll('#shelfButtons .btn-choice').forEach(btn => {
                if (btn.dataset.value === entry.shelf) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            hiddenShelfInput.value = entry.shelf || '';

            // Update button text and scroll to form
            submitButton.textContent = 'Update Entry';
            form.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Handles the click of a "Delete" button.
         * Opens the confirmation modal.
         * @param {string} docId - The document ID of the entry to delete.
         */
        function handleDeleteClick(docId) {
            // const docId = e.target.dataset.rowId; // No longer from event
            const entry = allEntries.find(item => item.id === docId);

            if (!entry) {
                showMessage('Could not find entry to delete.', true);
                return;
            }

            // Set the message and store the ID
            modalMessage.innerHTML = `Are you sure you want to delete <strong>${entry.item || 'this item'}</strong>? This action cannot be undone.`;
            docIdToDelete = docId;

            // Show the modal
            deleteModal.style.display = 'flex';
        }

        /**
         * Closes the delete confirmation modal.
         */
        function closeDeleteModal() {
            docIdToDelete = null;
            deleteModal.style.display = 'none';
        }

        /**
         * Confirms and executes the deletion.
         */
        async function confirmDelete() {
            if (!docIdToDelete) return;

            try {
                // Get a reference to the document using the full path
                const docRef = doc(db, COLLECTION_NAME, docIdToDelete);
                // Delete the document
                await deleteDoc(docRef);
                
                showMessage('Entry deleted successfully.', false);
                // onSnapshot will handle the table refresh automatically

            } catch (error) {
                console.error('Error deleting document:', error);
                showMessage(`Error: ${error.message}`, true);
            } finally {
                closeDeleteModal();
            }
        }

        /**
         * Closes the edit/delete choice modal.
         */
        function closeEditDeleteModal() {
            selectedEntry = null;
            editDeleteModal.style.display = 'none';
        }

        /**
         * Handles the click on a table row.
         * @param {Event} e - The click event.
         */
        function handleRowClick(e) {
            const docId = e.currentTarget.dataset.id;
            const entry = allEntries.find(item => item.id === docId);

            if (!entry) {
                showMessage('Could not find entry data.', true);
                return;
            }

            // Store the selected entry globally for modal buttons
            selectedEntry = entry;

            // Update modal text and show it
            editModalItemName.textContent = entry.item || 'this item';
            editDeleteModal.style.display = 'flex';
        }
        
        /**
         * Handles the "Modify" button click from the choice modal.
         */
        function handleModify() {
            if (!selectedEntry) return;
            handleEditClick(selectedEntry.id); // Call refactored function
            closeEditDeleteModal();
        }

        /**
         * Handles the "Delete" button click from the choice modal.
         */
        function handleDelete() {
            if (!selectedEntry) return;
            handleDeleteClick(selectedEntry.id); // Call refactored function
            closeEditDeleteModal(); // This modal closes, the confirm modal opens
        }

        /**
         * Filters the provided entries list based on the query.
         * @param {Array} entries - The list of entries to filter.
         * @param {string} query - The search query.
         * @returns {Array} - The filtered list of entries.
         */
        function filterEntries(entries, query) {
             return entries.filter(entry => {
                const item = (entry.item || '').toLowerCase();
                const notes = (entry.notes || '').toLowerCase();
                const exp = (entry.earliestExpiration || '').toLowerCase();
                
                return item.includes(query) || notes.includes(query) || exp.includes(query);
            });
        }
        
        /**
         * Filters the displayed table based on search box input.
         * This searches the local `allEntries` array and re-renders.
         */
        function handleSearch() {
            // Re-render the table with the current search query
            // renderTable will use allEntries and apply the filter
            renderTable(allEntries);
        }

        /**
         * Escapes cell data for CSV export.
         * @param {*} cellData - The data to escape.
         * @returns {string} - The escaped string.
         */
        function escapeCSV(cellData) {
            if (cellData == null) { // handles null or undefined
                return '';
            }
            const str = String(cellData);
            
            // If the string contains a comma, double quote, or newline,
            // wrap it in double quotes and escape existing double quotes.
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            
            return str;
        }
        
        /**
         * Exports all entries to a CSV file.
         */
        function handleExport() {
            // Use allEntries, but apply the current search filter first
            const query = searchBox.value.toLowerCase().trim();
            const entriesToExport = query ? filterEntries(allEntries, query) : allEntries;

            if (entriesToExport.length === 0) {
                showMessage('No data to export (based on current filter).', true);
                return;
            }

            const headers = ['Cabinet', 'Shelf', 'Item', 'Quantity', 'EarliestExpiration', 'Notes', 'LastUpdated'];
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            
            entriesToExport.forEach(entry => {
                // --- Reformat Expiration Date for CSV ---
                let formattedExpDate = '';
                // Check if the date is a valid YYYY-MM-DD string
                if (entry.earliestExpiration && /^\d{4}-\d{2}-\d{2}$/.test(entry.earliestExpiration)) {
                    try {
                        const parts = entry.earliestExpiration.split('-');
                        // parts = ['YYYY', 'MM', 'DD']
                        formattedExpDate = `${parts[1]}/${parts[2]}/${parts[0]}`;
                    } catch (e) {
                         // Fallback just in case split fails, though unlikely with test
                        formattedExpDate = entry.earliestExpiration;
                    }
                } else {
                    // Use the original value if it's null, empty, or not in YYYY-MM-DD format
                    formattedExpDate = entry.earliestExpiration || '';
                }
                // --- End Date Formatting ---

                // --- Reformat Last Updated Date for CSV ---
                let formattedUpdated = '';
                if (entry.lastUpdated?.toDate) {
                    const date = entry.lastUpdated.toDate();
                    
                    // Date part: MM/DD/YYYY
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = date.getFullYear();
                    const datePart = `${month}/${day}/${year}`;
                    
                    // Time part: HH:mm (24-hour)
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const timePart = `${hours}:${minutes}`;
                    
                    formattedUpdated = `${datePart} ${timePart}`;
                }
                // --- End Last Updated Formatting ---

                // Get timestamp as ISO string for consistent format
                // const updated = entry.lastUpdated?.toDate ? entry.lastUpdated.toDate().toISOString() : '';
                
                const row = [
                    escapeCSV(entry.cabinet),
                    escapeCSV(entry.shelf),
                    escapeCSV(entry.item),
                    escapeCSV(entry.quantity),
                    escapeCSV(formattedExpDate), // <-- Use the new formatted date
                    escapeCSV(entry.notes),
                    escapeCSV(formattedUpdated) // <-- Use the new formatted updated timestamp
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().split('T')[0];
                const filename = query ? `supplies_export_${date}_filtered.csv` : `supplies_export_${date}.csv`;
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        /**
         * Attaches the Firestore listener to the collection.
         */
        function attachDataListener() {
            // Detach any existing listener to avoid duplicates
            if (entriesListener) {
                entriesListener();
            }
            
            // Now that we're authenticated, we can listen for data.
            const collectionRef = collection(db, COLLECTION_NAME);
            
            entriesListener = onSnapshot(collectionRef, (querySnapshot) => {
                const entries = [];
                querySnapshot.forEach((doc) => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                
                renderTable(entries); // Render the live data
                
                // Hide loading indicators
                loadingIndicator.style.display = 'none';
                loadingMessage.style.display = 'none';
                
            }, (error) => { // <-- FIXED: Added arrow and braces
                console.error('Error getting documents:', error);
                loadingMessage.textContent = `Error loading data: ${error.message}`;
                loadingMessage.className = 'text-red-500 text-center p-8';
            });
        }

        /**
         * --- APP INITIALIZATION ---
         * Runs when the script loads.
         */
        function initApp() {
            try {
                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Enable verbose logging for Firestore
                // setLogLevel('debug'); // Removed for cleaner console

                loadingMessage.style.display = 'block';

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        currentUserId = user.uid;
                        console.log("User authenticated with UID:", currentUserId); // Debug log
                        loadingMessage.textContent = 'Authenticated. Loading entries...';
                        
                        // --- Attach Firestore listener ---
                        attachDataListener();

                    } else {
                        // User is signed out. Try to sign in.
                        currentUserId = null;
                        loadingMessage.textContent = 'Authenticating...';
                        console.log("No user. Attempting sign-in..."); // Debug log
                        try {
                            // Only use signInAnonymously as the auth method
                            console.log("Signing in anonymously..."); // Debug log
                            await signInAnonymously(auth);
                            
                            // The onAuthStateChanged listener will fire again
                            // once signed in, triggering the data load.
                        } catch (error) {
                            console.error('Error signing in:', error);
                            loadingMessage.textContent = `Authentication Failed: ${error.message}`;
                            loadingMessage.className = 'text-red-500 text-center p-8';
                        }
                    }
                });

                // --- Add Form and Button Event Listeners ---
                form.addEventListener('submit', handleFormSubmit);
                clearButton.addEventListener('click', clearForm);
                searchBox.addEventListener('input', handleSearch);
                exportButton.addEventListener('click', handleExport); // Add listener for new button

                // Modal button listeners
                modalCancel.addEventListener('click', closeDeleteModal);
                modalConfirmDelete.addEventListener('click', confirmDelete);

                // --- NEW Modal button listeners ---
                modalModify.addEventListener('click', handleModify);
                modalDelete.addEventListener('click', handleDelete);
                modalChoiceCancel.addEventListener('click', closeEditDeleteModal);

                // Handle Cabinet Button Clicks
                cabinetButtonsContainer.addEventListener('click', (e) => {
                    handleButtonChoice(e, cabinetButtonsContainer, hiddenCabinetInput);
                });

                // Handle Shelf Button Clicks
                shelfButtonsContainer.addEventListener('click', (e) => {
                    handleButtonChoice(e, shelfButtonsContainer, hiddenShelfInput);
                });

            } catch (error) {
                console.error('Error initializing app:', error);
                loadingIndicator.style.display = 'none';
                loadingMessage.textContent = `Critical Error: ${error.message}`;
                loadingMessage.style.display = 'block';
                loadingMessage.className = 'text-red-500 text-center p-8';
            }
        }

        // --- Start the application ---
        initApp();

    </script>
</body>
</html>